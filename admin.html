<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Admin – Suunnistuspeli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 2em; }
    h2 { margin-bottom: 1em; }
    .rasti { border: 1px solid #ccc; padding: 1em; margin-bottom: 1em; }
    textarea { width: 100%; min-height: 60px; margin-top: 0.5em; }
    input[type="file"] { margin-bottom: 1em; }
    button { padding: 0.5em 1em; margin-top: 0.5em; }
    #admin-panel { display: none; }
  </style>
</head>
<body>
  <div id="kirjautuminen">
    <h2>Kirjaudu sisään</h2>
    <input type="password" id="salasana" placeholder="Salasana">
    <button onclick="tarkistaSalasana()">Kirjaudu</button>
    <div id="virhe" style="color:red;"></div>
  </div>

  <div id="admin-panel">
    <h2>Admin-paneeli</h2>
    <input type="file" id="gpx-file" accept=".gpx">
    <button onclick="lataaGPX()">Lataa GPX ja tallenna palvelimelle</button>
    <div id="rasti-lista"></div>
  </div>

  <script>
    const OIKEA_SALASANA = "141592"; // Piin kuusi ensimmäistä desimaalia

    function tarkistaSalasana() {
      const syote = document.getElementById("salasana").value;
      if (syote === OIKEA_SALASANA) {
        document.getElementById("kirjautuminen").style.display = "none";
        document.getElementById("admin-panel").style.display = "block";
      } else {
        document.getElementById("virhe").innerText = "Väärä salasana";
      }
    }

    let rastit = [];

    function lataaGPX() {
      const fileInput = document.getElementById('gpx-file');
      const file = fileInput.files[0];
      if (!file) return alert("Valitse GPX-tiedosto");

      const reader = new FileReader();
      reader.onload = async function (e) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "application/xml");
        const trkpts = xmlDoc.getElementsByTagName("trkpt");

        rastit = [];
        for (let i = 0; i < trkpts.length; i++) {
          const pt = trkpts[i];
          const nimi = `Rasti ${i + 1}`;
          const lat = parseFloat(pt.getAttribute("lat"));
          const lon = parseFloat(pt.getAttribute("lon"));
          rastit.push({ nimi, lat, lon, tehtava: "" });
        }

        paivitaLista();
        tallennaPalvelimelle();
      }
      reader.readAsText(file);
    }

    function paivitaLista() {
      const container = document.getElementById("rasti-lista");
      container.innerHTML = "";
      rastit.forEach((r, idx) => {
        const div = document.createElement("div");
        div.className = "rasti";
        div.innerHTML = `
          <strong>${r.nimi}</strong><br>
          Lat: ${r.lat}, Lon: ${r.lon}<br>
          <label>Tehtävä:</label>
          <textarea onchange="muokkaaTehtavaa(${idx}, this.value)">${r.tehtava}</textarea>
          <br><button onclick="poistaRasti(${idx})">Poista rasti</button>
        `;
        container.appendChild(div);
      });
    }

    function muokkaaTehtavaa(idx, value) {
      rastit[idx].tehtava = value;
      tallennaPalvelimelle();
    }

    function poistaRasti(idx) {
      if (!confirm("Haluatko varmasti poistaa rastin?")) return;
      rastit.splice(idx, 1);
      paivitaLista();
      tallennaPalvelimelle();
    }

    async function tallennaPalvelimelle() {
      try {
        await fetch("/rastit.json", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(rastit)
        });
        alert("Rastit tallennettu onnistuneesti!");
      } catch (err) {
        alert("Tallennus epäonnistui: " + err);
      }
    }
  </script>
</body>
</html>
