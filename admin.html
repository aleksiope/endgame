<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Rastien hallinta</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; }
    #map { height: 300px; width: 100%; margin-bottom: 1em; }
    .rasti { border: 1px solid #ccc; padding: 1em; margin-bottom: 1em; background: #f9f9f9; }
    textarea { width: 100%; height: 60px; }
    button { margin-top: 0.5em; }
  </style>
</head>
<body>

<h2>Admin - Rastien hallinta</h2>

<label>Salasana: <input type="password" id="salasana" /></label>
<button onclick="kirjaudu()">Kirjaudu</button>

<div id="adminSisalto" style="display:none;">
  <h3>Rastien lataus GPX-tiedostosta</h3>
  <input type="file" id="gpxInput" accept=".gpx">
  <button onclick="lataaGPX()">Lataa GPX</button>

  <div id="map"></div>

  <h3>Rastit</h3>
  <div id="rastiLista"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/togeojson"></script>
<script>
let kartta;
let rastit = [];

function kirjaudu() {
  const pwd = document.getElementById("salasana").value;
  if (pwd === "admin123") {
    document.getElementById("adminSisalto").style.display = "block";
  } else {
    alert("Väärä salasana");
  }
}

function alustaKartta() {
  kartta = L.map('map').setView([65, 25], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(kartta);
}

function lataaGPX() {
  const input = document.getElementById('gpxInput');
  const file = input.files[0];
  if (!file) return alert("Valitse GPX-tiedosto");

  const reader = new FileReader();
  reader.onload = function(e) {
    const parser = new DOMParser();
    const xml = parser.parseFromString(e.target.result, 'text/xml');
    const geojson = toGeoJSON.gpx(xml);
    rastit = geojson.features.map((f, idx) => ({
      nimi: f.properties.name || `Rasti ${idx+1}`,
      lat: f.geometry.coordinates[1],
      lon: f.geometry.coordinates[0],
      tehtava: ""
    }));
    paivitaKartta();
    paivitaRastiLista();
    tallennaRastit();
  }
  reader.readAsText(file);
}

function paivitaKartta() {
  if (!kartta) alustaKartta();
  rastit.forEach(r => {
    L.marker([r.lat, r.lon]).addTo(kartta).bindPopup(r.nimi);
  });
}

function paivitaRastiLista() {
  const div = document.getElementById("rastiLista");
  div.innerHTML = "";
  rastit.forEach((r, i) => {
    const el = document.createElement("div");
    el.className = "rasti";
    el.innerHTML = `
      <strong>${r.nimi}</strong><br/>
      <label>Tehtävä:</label><br/>
      <textarea onchange="muokkaaTehtavaa(${i}, this.value)">${r.tehtava || ""}</textarea><br/>
      <button onclick="poistaRasti(${i})">Poista</button>
    `;
    div.appendChild(el);
  });
}

function muokkaaTehtavaa(index, uusi) {
  rastit[index].tehtava = uusi;
  tallennaRastit();
}

function poistaRasti(index) {
  if (confirm("Haluatko varmasti poistaa rastin?")) {
    rastit.splice(index, 1);
    paivitaRastiLista();
    tallennaRastit();
  }
}

function tallennaRastit() {
  const blob = new Blob([JSON.stringify(rastit, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = "rastit.json";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
