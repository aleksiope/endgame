<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Suunnistuspeli - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 1em; }
    #map { height: 60vh; margin-bottom: 1em; }
    #login, #admin-tools { max-width: 600px; margin: auto; }
    .piilossa { display: none; }
    input, button { margin: 0.5em 0; display: block; width: 100%; }
    .rasti-item { margin-bottom: 1em; }
  </style>
</head>
<body>
  <h2>Admin - Suunnistuspeli</h2>
  <div id="login">
    <p>Syötä salasana päästäksesi hallintaan:</p>
    <input type="password" id="salasana" placeholder="Salasana">
    <button onclick="tarkistaSalasana()">Kirjaudu sisään</button>
  </div>

  <div id="admin-tools" class="piilossa">
    <input type="file" accept=".gpx" onchange="lueGPX(this.files[0])">
    <div id="map"></div>
    <div id="rasti-lista"></div>
    <button onclick="tallennaRastit()">Tallenna rastit selaimen muistiin</button>
  </div>

  <script>
    const oikeaSalasana = "141592"; // Piin kuusi ensimmäistä desimaalia
    let rastit = [];
    let kartta;

    function tarkistaSalasana() {
      const syote = document.getElementById("salasana").value;
      if (syote === oikeaSalasana) {
        document.getElementById("login").classList.add("piilossa");
        document.getElementById("admin-tools").classList.remove("piilossa");
        naytaKartta();
      } else {
        alert("Väärä salasana. Ethän vain yritä murtautua järjestelmään?");
      }
    }

    function naytaKartta() {
      kartta = L.map('map').setView([60.192059, 24.945831], 12);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(kartta);
    }

    function lueGPX(tiedosto) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const parser = new DOMParser();
        const xml = parser.parseFromString(e.target.result, "application/xml");
        const waypoints = xml.getElementsByTagName("wpt");
        rastit = [];

        for (let wpt of waypoints) {
          const lat = parseFloat(wpt.getAttribute("lat"));
          const lon = parseFloat(wpt.getAttribute("lon"));
          const nimi = wpt.getElementsByTagName("name")[0]?.textContent || "Rasti";
          const tehtava = wpt.getElementsByTagName("desc")[0]?.textContent || "Tehtävä puuttuu";
          rastit.push({ nimi, lat, lon, tehtava });
        }

        naytaRastit();
      };
      reader.readAsText(tiedosto);
    }

    function naytaRastit() {
      document.getElementById("rasti-lista").innerHTML = "";
      rastit.forEach(rasti => {
        L.marker([rasti.lat, rasti.lon]).addTo(kartta).bindPopup(rasti.nimi);
        const div = document.createElement("div");
        div.className = "rasti-item";
        div.innerHTML = `<strong>${rasti.nimi}</strong><br>${rasti.tehtava}`;
        document.getElementById("rasti-lista").appendChild(div);
      });
    }

    function tallennaRastit() {
      localStorage.setItem("rastit", JSON.stringify(rastit));
      alert("Rastit tallennettu selaimen muistiin. Pelaajat voivat nyt käyttää index.html-sivua.");
    }
  </script>
</body>
</html>
