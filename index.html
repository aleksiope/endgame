<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<title>Suunnistuspeli</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { font-family: Arial, sans-serif; padding: 1em; }
  #map { height: 400px; margin-bottom: 1em; }
  #pistetilanne { margin: 1em 0; font-weight: bold; }
  .tehtava { border: 1px solid #ccc; padding: 0.5em; margin-bottom: 1em; }
  textarea { width: 100%; height: 80px; }
  button { margin-top: 0.5em; }
</style>
</head>
<body>

<h2>Suunnistuspeli</h2>

<label>Nimi: <input type="text" id="pelaajanNimi" /></label>
<button id="aloitaPeliBtn">Aloita peli</button>

<div id="pistetilanne" style="display:none;"></div>

<div id="map"></div>

<button id="tarkistaSijaintiBtn" style="display:none;">Tarkista GPS</button>

<div id="rastit"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map;
let rastit = [];
let pelaaja = { nimi: "", pisteet: 0, avatut: [] };
const MAX_ETAISYYS = 30; // metriä, max etäisyys rastille
const rastitDiv = document.getElementById('rastit');

function alustaKartta() {
  map = L.map('map').setView([65, 25], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);
}

function paivitaPistetilanne() {
  const maxPisteet = rastit.length;
  const pisteet = pelaaja.pisteet;
  document.getElementById('pistetilanne').textContent = `Pisteet: ${pisteet} / ${maxPisteet}`;
}

function naytaRasti(rasti) {
  rastitDiv.innerHTML = `
    <div class="tehtava">
      <h3>${rasti.nimi}</h3>
      <p>${rasti.tehtava || "(tehtävä puuttuu)"}</p>
      <label>Vastauksesi (vähintään 10 merkkiä):</label><br/>
      <textarea id="vastausKentta">${rasti.vastaus || ""}</textarea><br/>
      <button id="tallennaVastausBtn">Tallenna vastaus</button>
    </div>
  `;

  document.getElementById('tallennaVastausBtn').onclick = () => {
    const vastaus = document.getElementById('vastausKentta').value.trim();
    if (vastaus.length < 10) {
      alert("Vastaus on liian lyhyt, kirjoita vähintään 10 merkkiä.");
      return;
    }
    rasti.vastaus = vastaus;
    if (!pelaaja.avatut.includes(rasti.nimi)) {
      pelaaja.avatut.push(rasti.nimi);
      pelaaja.pisteet++;
      paivitaPistetilanne();
    }
    alert("Vastaus tallennettu!");
  };
}

function tarkistaSijainti() {
  if (!navigator.geolocation) {
    alert("Sijainnin haku ei onnistu, selain ei tue geolokaatiota.");
    return;
  }
  rastitDiv.innerHTML = "<p>Haetaan laitteen sijaintia...</p>";
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    let loytynytRasti = null;
    for (const r of rastit) {
      const etaisyys = laskeEtaisyys(lat, lon, r.lat, r.lon);
      if (etaisyys <= MAX_ETAISYYS) {
        loytynytRasti = r;
        break;
      }
    }
    if (loytynytRasti) {
      naytaRasti(loytynytRasti);
    } else {
      rastitDiv.innerHTML = "<p>Et ole tarpeeksi lähellä mitään rastia.</p>";
    }
  }, err => {
    rastitDiv.innerHTML = "<p>Sijainnin hakeminen epäonnistui.</p>";
  });
}

function laskeEtaisyys(lat1, lon1, lat2, lon2) {
  function rad(deg) { return deg * Math.PI / 180; }
  const R = 6371000; // maan säde metreinä
  const dLat = rad(lat2 - lat1);
  const dLon = rad(lon2 - lon1);
  const a = Math.sin(dLat/2) ** 2 + Math.cos(rad(lat1)) * Math.cos(rad(lat2)) * Math.sin(dLon/2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

document.getElementById('aloitaPeliBtn').onclick = () => {
  const nimi = document.getElementById('pelaajanNimi').value.trim();
  if (nimi.length < 2) {
    alert("Kirjoita nimesi aloittaaksesi pelin.");
    return;
  }
  pelaaja.nimi = nimi;
  pelaaja.pisteet = 0;
  pelaaja.avatut = [];
  paivitaPistetilanne();
  document.getElementById('pistetilanne').style.display = "block";
  document.getElementById('tarkistaSijaintiBtn').style.display = "inline-block";
};

document.getElementById('tarkistaSijaintiBtn').onclick = tarkistaSijainti;

function lataaRastit() {
  fetch("rastit.json")
    .then(res => {
      if(!res.ok) throw new Error("Rastit.json ei löytynyt");
      return res.json();
    })
    .then(data => {
      rastit = data;
      alustaKartta();
      rastit.forEach(r => {
        L.marker([r.lat, r.lon]).addTo(map).bindPopup(r.nimi);
      });
    })
    .catch(err => {
      alert("Rastien lataus epäonnistui: " + err.message);
    });
}

lataaRastit();

</script>

</body>
</html>
