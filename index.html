<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suunnistuspeli</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 1em; }
    #map { height: 50vh; width: 100%; margin-bottom: 1em; }
    #rastilista { margin-top: 1em; }
    .rasti { border: 1px solid #ccc; padding: 1em; margin-bottom: 1em; border-radius: 8px; background: #f9f9f9; }
    textarea { width: 100%; height: 60px; }
    .piilossa { display: none; }
    #pistetilanne { font-weight: bold; margin-top: 1em; }
  </style>
</head>
<body>

<h2>Suunnistuspeli</h2>

<label>Syötä nimesi: <input type="text" id="pelaajaNimi"></label>
<button onclick="aloitaPeli()">Aloita peli</button>

<div id="peliSisalto" style="display:none;">
  <div id="map"></div>
  <button onclick="tarkistaSijainti()">Tarkista sijainti</button>
  <div id="tila"></div>
  <div id="pistetilanne"></div>
  <div id="rastilista"></div>
</div>

<audio id="onnistuiAudio" src="success.mp3"></audio>
<audio id="epaonnistuiAudio" src="fail.mp3"></audio>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let kartta;
let rastit = [];
let saavutetut = {};
let pelaaja = "";

function aloitaPeli() {
  pelaaja = document.getElementById("pelaajaNimi").value.trim();
  if (!pelaaja) return alert("Syötä nimi aloittaaksesi pelin");
  document.getElementById("peliSisalto").style.display = "block";
  haeRastit();
  alustaKartta();
}

function alustaKartta() {
  kartta = L.map('map').setView([65, 25], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(kartta);
}

function haeRastit() {
  fetch('testirastit.json')
    .then(res => res.json())
    .then(data => {
      rastit = data;
      paivitaRastilista();
      rastit.forEach(r => L.marker([r.lat, r.lon]).addTo(kartta).bindPopup(r.nimi));
    });
}

function paivitaRastilista() {
  const div = document.getElementById("rastilista");
  div.innerHTML = "";
  rastit.forEach((r, i) => {
    const el = document.createElement("div");
    el.className = "rasti";
    el.id = `rasti-${i}`;
    el.innerHTML = `
      <strong>${r.nimi}</strong>
      <div id="tehtava-${i}" class="piilossa">
        <p>${r.tehtava}</p>
        <textarea id="vastaus-${i}" placeholder="Kirjoita vastauksesi"></textarea>
        <button onclick="tallennaVastaus(${i})">Tallenna vastaus</button>
      </div>
    `;
    div.appendChild(el);
  });
  paivitaPisteet();
}

function tarkistaSijainti() {
  document.getElementById("tila").textContent = "Haetaan laitteen sijaintia...";
  navigator.vibrate(0);

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    let loytyi = false;

    rastit.forEach((r, i) => {
      const etaisyys = laskeEtaisyys(lat, lon, r.lat, r.lon);
      if (etaisyys < 30 && !saavutetut[i]) {
        document.getElementById(`tehtava-${i}`).classList.remove("piilossa");
        saavutetut[i] = true;
        loytyi = true;
      }
    });

    if (loytyi) {
      document.getElementById("tila").textContent = "Rasti saavutettu!";
      navigator.vibrate(200);
      document.getElementById("onnistuiAudio").play();
    } else {
      document.getElementById("tila").textContent = "Et ole tarpeeksi lähellä rastia.";
      navigator.vibrate([100, 50, 100]);
      document.getElementById("epaonnistuiAudio").play();
    }
    paivitaPisteet();
  }, () => {
    document.getElementById("tila").textContent = "Sijainnin haku epäonnistui.";
    navigator.vibrate([100, 100, 100]);
    document.getElementById("epaonnistuiAudio").play();
  });
}

function laskeEtaisyys(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function tallennaVastaus(i) {
  const vastaus = document.getElementById(`vastaus-${i}`).value.trim();
  if (vastaus.length < 10) {
    alert("Vastaus on liian lyhyt. Kirjoita vähintään 10 merkkiä.");
    return;
  }
  saavutetut[i] = true;
  alert("Vastaus tallennettu!");
  paivitaPisteet();
}

function paivitaPisteet() {
  const pisteet = Object.keys(saavutetut).length;
  const max = rastit.length;
  document.getElementById("pistetilanne").textContent = `Pisteet: ${pisteet}/${max}`;
}
</script>

</body>
</html>
