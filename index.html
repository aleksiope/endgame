<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Suunnistuspeli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 2em; }
    #kartta { width: 100%; height: 300px; background: #eee; margin-bottom: 1em; }
    .rasti { border: 1px solid #ccc; padding: 1em; margin-bottom: 1em; }
    #status { font-weight: bold; margin-top: 1em; }
    textarea { width: 100%; min-height: 60px; }
    button { margin-top: 0.5em; }
    #pisteet { margin-top: 1em; font-size: 1.2em; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Suunnistuspeli</h1>

  <label for="nimi">Syötä nimesi aloittaaksesi peli:</label>
  <input type="text" id="nimi">
  <button onclick="aloitaPeli()">Aloita peli</button>

  <div id="pisteet" style="display:none;"></div>
  <div id="kartta">[Kartta placeholder]</div>

  <button onclick="tarkistaSijainti()">Tarkista sijainti</button>
  <div id="status"></div>

  <div id="rastit"></div>

  <audio id="onnistunut" src="success.mp3"></audio>
  <audio id="epaonnistunut" src="fail.mp3"></audio>

  <script>
    let rastit = [];
    let pisteet = 0;
    let nimi = "";
    const pisteNaytto = document.getElementById("pisteet");

    async function aloitaPeli() {
      nimi = document.getElementById("nimi").value.trim();
      if (!nimi) return alert("Syötä nimesi!");
      pisteet = 0;
      pisteNaytto.style.display = "block";
      await haeRastit();
      paivitaPisteet();
    }

    async function haeRastit() {
      try {
        const res = await fetch("/rastit.json");
        rastit = await res.json();
        rastit.forEach(r => r.avaa = false);
        paivitaRastiNaytto();
      } catch (err) {
        document.getElementById("status").innerText = "Rastien lataus epäonnistui.";
      }
    }

    function paivitaPisteet() {
      const max = rastit.length;
      const saavutetut = rastit.filter(r => r.vastaus).length;
      pisteNaytto.innerText = `Pisteet: ${saavutetut}/${max}`;
    }

    function paivitaRastiNaytto() {
      const container = document.getElementById("rastit");
      container.innerHTML = "";
      rastit.forEach((r, idx) => {
        if (!r.avaa) return;
        const div = document.createElement("div");
        div.className = "rasti";
        div.innerHTML = `
          <strong>${r.nimi}</strong><br>
          <p>${r.tehtava}</p>
          <textarea placeholder="Vastauksesi" oninput="validoi(${idx}, this)"></textarea>
          <button disabled onclick="tallennaVastaus(${idx}, this.previousElementSibling.value)">Tallenna vastaus</button>
        `;
        container.appendChild(div);
      });
    }

    function validoi(idx, textarea) {
      const btn = textarea.nextElementSibling;
      btn.disabled = textarea.value.trim().length < 10;
    }

    function tallennaVastaus(idx, vastaus) {
      rastit[idx].vastaus = vastaus;
      rastit[idx].avaa = false;
      paivitaRastiNaytto();
      paivitaPisteet();
    }

    function tarkistaSijainti() {
      const status = document.getElementById("status");
      status.innerText = "Haetaan laitteen sijaintia...";

      navigator.vibrate?.(200);

      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        let loytyi = false;

        rastit.forEach((r, idx) => {
          const etaisyys = getDistanceFromLatLonInM(latitude, longitude, r.lat, r.lon);
          if (etaisyys < 30 && !r.vastaus) {
            r.avaa = true;
            loytyi = true;
          }
        });

        if (loytyi) {
          document.getElementById("onnistunut").play();
          navigator.vibrate?.([100, 50, 100]);
          status.innerText = "Rasti löytyi!";
        } else {
          document.getElementById("epaonnistunut").play();
          navigator.vibrate?.([300]);
          status.innerText = "Et ole tarpeeksi lähellä rastia.";
        }

        paivitaRastiNaytto();
      }, err => {
        document.getElementById("epaonnistunut").play();
        status.innerText = "Sijainnin haku epäonnistui.";
      });
    }

    function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
      const R = 6371000; // metriä
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
  </script>
</body>
</html>
