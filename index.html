<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Suunnistuspeli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; }
    #map { height: 60vh; margin-bottom: 1em; }
    #vastaus-box { margin-top: 1em; }
    textarea { width: 100%; min-height: 80px; margin: 0.5em 0; }
    button { padding: 0.5em 1em; }
    #pistetilanne { margin-top: 1em; font-weight: bold; }
    #nimi-kentta, #aloita-nappi { margin-bottom: 1em; }
    .piilossa { display: none; }
    #sijainti-status { margin: 0.5em 0; font-style: italic; }
  </style>
</head>
<body>
  <h2>Suunnistuspeli</h2>
  <div id="aloitus">
    <label for="pelaaja-nimi">Syötä nimesi aloittaaksesi pelin:</label>
    <input type="text" id="pelaaja-nimi" placeholder="Nimesi">
    <button id="aloita-nappi" onclick="aloitaPeli()">Aloita peli</button>
  </div>

  <div id="peli" class="piilossa">
    <div id="map"></div>
    <button onclick="tarkistaGPS()">Tarkista sijainti</button>
    <div id="sijainti-status"></div>
    <div id="tehtava"></div>
    <div id="vastaus-box" class="piilossa">
      <textarea id="vastaus" placeholder="Kirjoita vastauksesi tähän"></textarea>
      <button onclick="tallennaVastaus()">Tallenna vastaus</button>
    </div>
    <div id="pistetilanne"></div>
  </div>

  <audio id="onnistui-audio" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
  <audio id="epaonnistui-audio" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <script>
    let rastit = JSON.parse(localStorage.getItem("rastit")) || [];
    let saavutetut = {};
    let kartta, pelaajanMarker;
    let pelaajaNimi = "";

    function aloitaPeli() {
      const nimiKentta = document.getElementById("pelaaja-nimi");
      if (nimiKentta.value.trim() === "") {
        alert("Syötä nimesi!");
        return;
      }
      pelaajaNimi = nimiKentta.value.trim();
      document.getElementById("aloitus").classList.add("piilossa");
      document.getElementById("peli").classList.remove("piilossa");
      naytaKartta();
      paivitaPisteet();
    }

    function naytaKartta() {
      kartta = L.map('map').setView([60.192059, 24.945831], 12);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(kartta);
    }

    function tarkistaGPS() {
      const status = document.getElementById("sijainti-status");
      status.textContent = "Haetaan laitteesi sijaintia...";

      if (!navigator.geolocation) {
        alert("Selaimesi ei tue sijainnin hakua. Ota yhteyttä opeen.");
        status.textContent = "";
        return;
      }

      navigator.geolocation.getCurrentPosition(sijainti =>   g z  {
        const lat = sijainti.coords.latitude;
        const lon = sijainti.coords.longitude;

        if (pelaajanMarker) kartta.removeLayer(pelaajanMarker);
        pelaajanMarker = L.marker([lat, lon]).addTo(kartta).bindPopup("Olet tässä").openPopup();
        kartta.setView([lat, lon], 15);

        const lahin = rastit.find(r => laskeEtaisyys(lat, lon, r.lat, r.lon) < 30 && !saavutetut[r.nimi]);

        if (lahin) {
          document.getElementById("tehtava").innerHTML = `<strong>${lahin.nimi}</strong><br>${lahin.tehtava}`;
          document.getElementById("vastaus-box").classList.remove("piilossa");
          document.getElementById("vastaus").setAttribute("data-rasti", lahin.nimi);

          document.getElementById("onnistui-audio").play();
          if (navigator.vibrate) navigator.vibrate(300);
        } else {
          document.getElementById("tehtava").innerHTML = "Lähistöllä ei ole löytämättömiä rasteja.";
          document.getElementById("vastaus-box").classList.add("piilossa");

          document.getElementById("epaonnistui-audio").play();
          if (navigator.vibrate) navigator.vibrate([100, 100, 100]);
        }
        status.textContent = "";
      }, err => {
        status.textContent = "Sijainnin haku epäonnistui.";
        document.getElementById("epaonnistui-audio").play();
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      });
    }

    function laskeEtaisyys(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2 - lat1) * Math.PI/180;
      const Δλ = (lon2 - lon1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function tallennaVastaus() {
      const textarea = document.getElementById("vastaus");
      const vastaus = textarea.value.trim();
      const rasti = textarea.getAttribute("data-rasti");

      if (vastaus.length < 10) {
        alert("Vastauksesi on liian lyhyt! Korjaa vastaustasi.");
        return;
      }

      saavutetut[rasti] = vastaus;
      textarea.value = "";
      document.getElementById("tehtava").innerHTML = "Vastaus tallennettu!";
      document.getElementById("vastaus-box").classList.add("piilossa");
      paivitaPisteet();
    }

    function paivitaPisteet() {
      const pisteet = Object.keys(saavutetut).length;
      const maksimipisteet = rastit.length;
      document.getElementById("pistetilanne").textContent = `Pisteet: ${pisteet} / ${maksimipisteet}`;
    }
  </script>
</body>
</html>
